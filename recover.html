<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Plan - Data Recovery</title>
    <style>
        body { background: #121212; color: #ececec; font-family: sans-serif; padding: 20px; }
        .card { background: #1e1e1e; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .btn { background: #f29b11; color: #000; border: none; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .log-item { border-left: 3px solid #f29b11; padding-left: 10px; margin: 10px 0; font-size: 12px; }
        h1 { color: #f29b11; font-size: 20px; text-transform: uppercase; }
        pre { background: #000; padding: 10px; overflow: auto; font-size: 10px; }
    </style>
</head>
<body>
    <h1>Data Recovery Tool</h1>
    <p>Scanning local storage for unsynced workout data...</p>
    
    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://vhqgufwgzspwmztpswdn.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZocWd1ZndnenNwd216dHBzd2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTc2NjUsImV4cCI6MjA4MzMzMzY2NX0.0z_hSGbzjzSWkXaZjgJ76uWsVdBa4h0OCkzEXs727pc';

        // 1. Find User ID from Supabase Auth storage
        let userId = null;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.includes('-auth-token')) {
                const authData = JSON.parse(localStorage.getItem(key));
                userId = authData?.user?.id;
                console.log("Found User ID:", userId);
            }
        }

        const resultsDiv = document.getElementById('results');
        const storageKeys = ['mp-training-storage-v18', 'mp-training-storage-v20', 'mp-training-storage-v21', 'mp-training-storage-v23'];
        
        let foundData = false;

        storageKeys.forEach(key => {
            const raw = localStorage.getItem(key);
            if (!raw) return;

            const parsed = JSON.parse(raw);
            const state = parsed.state;
            
            // Check if there are logs in this version
            if (state && state.activeSession && Object.keys(state.activeSession.logs || {}).length > 0) {
                foundData = true;
                const session = state.activeSession;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>Found in ${key}</h3>
                    <p>Start: ${new Date(session.startTime).toLocaleString()}</p>
                    <div id="details-${key}"></div>
                    <button class="btn" onclick="forceSync('${key}')">FORCE SYNC TO CLOUD</button>
                `;
                resultsDiv.appendChild(card);

                // Show set counts
                const details = document.getElementById(`details-${key}`);
                Object.entries(session.logs).forEach(([id, sets]) => {
                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.innerText = `Exercise ID ${id}: ${sets.length} sets logged.`;
                    details.appendChild(item);
                });
            }
        });

        if (!foundData) {
            resultsDiv.innerHTML = '<div class="card">No unsynced logs found in any storage version. Your data may have been cleared.</div>';
        }

        async function forceSync(storageKey) {
            if (!userId) {
                alert("Auth Error: Please log in to the app first, then come back here.");
                return;
            }

            const raw = localStorage.getItem(storageKey);
            const session = JSON.parse(raw).state.activeSession;

            try {
                // 1. Create Session Log
                const sessionRes = await fetch(`${SUPABASE_URL}/rest/v1/session_logs`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        routine_day_id: session.routine_day_id,
                        start_time: session.startTime,
                        end_time: new Date().toISOString()
                    })
                });

                const sessionData = await sessionRes.json();
                const sessionLogId = sessionData[0].id;

                // 2. Prepare Sets
                const setLogs = [];
                Object.entries(session.logs).forEach(([beId, sets]) => {
                    sets.forEach((s, idx) => {
                        setLogs.push({
                            session_log_id: sessionLogId,
                            block_exercise_id: beId,
                            weight: String(s.weight),
                            reps: parseInt(s.reps) || 0,
                            rpe: parseFloat(s.rpe) || null,
                            set_number: idx + 1
                        });
                    });
                });

                // 3. Bulk Insert Sets
                const setsRes = await fetch(`${SUPABASE_URL}/rest/v1/set_logs`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(setLogs)
                });

                if (setsRes.ok) {
                    alert("âœ… SUCCESS! Your workout has been recovered and saved to Supabase.");
                    // Clear the recovered storage to prevent duplicates
                    const data = JSON.parse(localStorage.getItem(storageKey));
                    data.state.activeSession = null;
                    localStorage.setItem(storageKey, JSON.stringify(data));
                    window.location.reload();
                } else {
                    throw new Error("Failed to save sets");
                }

            } catch (err) {
                console.error(err);
                alert("Recovery failed: " + err.message);
            }
        }
    </script>
</body>
</html>